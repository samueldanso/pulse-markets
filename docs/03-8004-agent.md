# ERC-8004 Agent Identity Integration

The Pulse Markets settlement oracle is registered as an ERC-8004 agent on Base, giving it a portable, on-chain identity with reputation tracking.

## Architecture

```
┌─────────────────────────────────────────────┐
│              Pulse Markets App               │
│                                              │
│  ┌──────────────┐  ┌─────────────────────┐  │
│  │ Settlement    │  │ Agent Identity      │  │
│  │ Service       │──│ Service (singleton) │  │
│  │ (AI + data)   │  │ - getAgentProof()   │  │
│  └──────────────┘  │ - verifyRegistration │  │
│                     └─────────────────────┘  │
│                              │               │
│  ┌──────────────────────────┐│               │
│  │ A2A Route (/api/agent)   ││               │
│  │ - agent-card.json        ││               │
│  │ - JSON-RPC 2.0           ││               │
│  └──────────────────────────┘│               │
└──────────────────────────────┼───────────────┘
                               │
              ┌────────────────┼────────────────┐
              │        Base (Chain 8453)         │
              │  IdentityRegistry  0x8004A1...   │
              │  ReputationRegistry 0x8004BA...  │
              └─────────────────────────────────┘
```

## Quick Start

### 1. Prerequisites

```env
# .env
PRIVATE_KEY=0x...          # Wallet with Base ETH for gas
PINATA_JWT=your_jwt        # From https://pinata.cloud (free tier)
WALLET_ADDRESS=0x...       # Same wallet as PRIVATE_KEY
```

### 2. Register the Agent

```bash
bun run register-agent
```

This mints an ERC-721 NFT on Base's IdentityRegistry, uploads metadata to IPFS via Pinata, and sets the agent URI on-chain.

After registration, add the output agent ID to `.env`:

```env
AGENT_ID=42
```

### 3. Verify

```bash
# Agent card discovery
curl http://localhost:3000/api/agent/.well-known/agent-card.json

# Health check includes agent status
curl http://localhost:3000/api/health

# Settlement response now includes agent proof
curl -X POST http://localhost:3000/api/settle/elon-twitter-attention
```

## Endpoints

| Method | Path | Purpose |
|--------|------|---------|
| GET | `/api/agent/.well-known/agent-card.json` | A2A agent card discovery |
| POST | `/api/agent/a2a` | JSON-RPC 2.0 (message/send, tasks/get) |
| POST | `/api/settle/:marketId` | Settlement with agent identity proof |

## Settlement Response

When `AGENT_ID` is set, every settlement response includes an `agent` field:

```json
{
  "success": true,
  "winner": "UP",
  "reasoning": "...",
  "agent": {
    "agentId": "42",
    "agentRegistry": "eip155:8453:0x8004A169FB4a3325136EB29fA0ceB6D2e539a432",
    "operatorAddress": "0x...",
    "registryUrl": "https://www.8004scan.io/agents/base/42",
    "reputation": {
      "tag1": "settlement",
      "tag2": "elon-twitter-attention",
      "value": 95,
      "feedbackTxHash": null
    }
  }
}
```

## A2A JSON-RPC

The agent supports the A2A protocol via `POST /api/agent/a2a`:

```json
{
  "jsonrpc": "2.0",
  "method": "message/send",
  "params": {
    "message": {
      "role": "user",
      "parts": [{ "type": "text", "text": "What markets are available?" }]
    }
  },
  "id": 1
}
```

Skills: `settle-market`, `market-info`.

## Reputation

ERC-8004 reputation is on-chain feedback from other addresses. The agent owner cannot self-review.

### Post feedback (demo)

```bash
# Requires a DIFFERENT wallet than the agent operator
FEEDBACK_PRIVATE_KEY=0x... AGENT_ID=42 bun run post-feedback
```

This calls `ReputationRegistry.giveFeedback()` with:
- `value`: 95 (settlement quality score)
- `tag1`: "settlement"
- `tag2`: topic (e.g., "elon-twitter-attention")

## Contract Addresses

### Base Mainnet (8453)

| Contract | Address |
|----------|---------|
| IdentityRegistry | `0x8004A169FB4a3325136EB29fA0ceB6D2e539a432` |
| ReputationRegistry | `0x8004BAa17C55a88189AE136b182e5fdA19dE9b63` |

### Base Sepolia (84532)

| Contract | Address |
|----------|---------|
| IdentityRegistry | `0x8004A818BFB912233c491871b3d84c89A494BD9e` |
| ReputationRegistry | `0x8004B663056A597Dffe9eCcC1965A193B7388713` |

## Files

| File | Purpose |
|------|---------|
| `lib/erc-8004/abis.ts` | Minimal contract ABIs |
| `lib/erc-8004/constants.ts` | Addresses, chain config |
| `server/services/agent-identity.ts` | Singleton service |
| `server/routes/agent.ts` | A2A discovery + JSON-RPC |
| `scripts/register-agent.ts` | One-time on-chain registration |
| `scripts/post-feedback.ts` | Reputation demo |

## Resources

- [ERC-8004 Spec](https://eips.ethereum.org/EIPS/eip-8004)
- [8004scan Explorer](https://www.8004scan.io/)
- [Agent0 SDK Docs](https://sdk.ag0.xyz/)
- [Registration Best Practices](https://github.com/erc-8004/best-practices/blob/main/Registration.md)
